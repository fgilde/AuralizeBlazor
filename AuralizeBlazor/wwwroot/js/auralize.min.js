export function initializeAuralizer(t,i,r){return new n(t,i,r)}class n{elementRef;dotnet;audioMotion;_featuresPaused=false;constructor(n,t,i){this.elementRef=n;this.dotnet=t;this.options=i;this.createVisualizer(i)}createVisualizer(n){this.audioMotion=new(window.AudioMotionAnalyzer||(window.AudioMotionAnalyzer=n.audioMotion.default))(this.visualizer=n.visualizer,this.options=this.prepareOptions(n));this.visualizer.addEventListener("click",this.onVisualizerClick.bind(this));this.visualizer.addEventListener("dblclick",this.onVisualizerDblClick.bind(this));this.visualizer.addEventListener("contextmenu",this.onVisualizerCtxMenu.bind(this));this.reconnectInputs();this.dotnet.invokeMethodAsync("HandleOnCreated");this.clickTimeout=null;this.preventSingleClick=!1}async onVisualizerCtxMenu(n){await this.handleAction(this.options.visualizerCtxMenuAction,n)}async onVisualizerDblClick(n){this.preventSingleClick=!0;this.clickTimeout&&clearTimeout(this.clickTimeout);await this.handleAction(this.options.visualizerDblClickAction,n)}async onVisualizerClick(n){this.clickTimeout=setTimeout(async()=>{this.preventSingleClick||await this.handleAction(this.options.visualizerClickAction,n),this.preventSingleClick=!1},300)}async handleAction(n,t){if(n!==0){t.preventDefault&&t.preventDefault();switch(n){case 1:this.pauseAllActive()||this.playAllActive(!0)||this.playAllActive();break;case 3:this._featuresPaused=!this._featuresPaused;break;case 4:this.togglePip();break;case 5:this.toggleFullscreen();break;case 6:this.connectToMic(!this.micStream);break;case 7:await this.dotnet.invokeMethodAsync("NextPresetAsync");break;case 8:await this.dotnet.invokeMethodAsync("PreviousPresetAsync")}}}invokeMethod(n,t,...i){const u=n.split(".");let r=window;for(const n of u.slice(0,-1))if(r=r[n],!r)return;if(r=r[u[u.length-1]],r){const f=r[t];f&&typeof f=="function"&&f.apply(r,[r].concat(i))}}prepareOptions(n){return n.fsElement=n.fsElement||n.visualizer,n.gradientLeft=n.gradientLeft||n.gradient,n.gradientRight=n.gradientRight||n.gradient,n.backgroundImage&&(this.visualizer.style.backgroundImage=`url('${n.backgroundImage}')`,this.visualizer.style.backgroundSize=n.backgroundSize||"cover",this.visualizer.style.backgroundRepeat=n.backgroundRepeat||"no-repeat",this.visualizer.style.backgroundPosition=n.backgroundPosition||"center"),n.features&&n.features.forEach(n=>this._ensureNamespace(n.jsNamespace)),n.gradient=this.registerGradientIfRequired(n.gradient),n.gradientLeft=this.registerGradientIfRequired(n.gradientLeft),n.gradientRight=this.registerGradientIfRequired(n.gradientRight),n.onCanvasDraw=(t,i)=>{!this._featuresPaused&&n.features&&n.features.forEach(n=>{const r=n.onCanvasDrawCallbackName,u=n.jsNamespace;this.invokeMethod(u,r,this,n.options||{},t,i)})},n.overlay=!0,n.overlay=n.overlay||n.backgroundImage,n}registerGradientIfRequired(n){if(!n)return"classic";if(typeof n=="string")return n;if(!n.name)return"classic";const t=n.name.toLowerCase();return this.audioMotion?._gradients?.[t]||!n.colorStops||n.isPredefined?t:(this.audioMotion.registerGradient(t,n),t)}connectToMic(n){!n&&this.micStream?(this.audioMotion.disconnectInput(this.micStream,!0),this.audioMotion.connectOutput(),this.micStream=null):n&&!this.micStream&&navigator.mediaDevices.getUserMedia({audio:!0}).then(n=>{this.micStream=this.audioMotion.audioCtx.createMediaStreamSource(n),this.audioMotion.disconnectOutput(),this.audioMotion.connectInput(this.micStream)}).catch(()=>console.log("Error accessing user microphone."))}playAllActive(n){let t=!1;return this.audioMotion?.connectedSources?.forEach(i=>{if(i.mediaElement&&i.mediaElement.paused){if(n&&!i.mediaElement.__autoPaused)return;i.mediaElement.play();delete i.mediaElement.__autoPaused;t=!0}}),t}pauseAllActive(){let n=!1;return this.audioMotion?.connectedSources?.forEach(t=>{t.mediaElement&&!t.mediaElement.paused&&(t.mediaElement.__autoPaused=!0,t.mediaElement.pause(),n=!0)}),n}disconnectInputs(){this.audioMotion?.connectedSources?.forEach(n=>{this.audioMotion.disconnectInput(n.gain),n.mediaElement&&n.mediaElement.listeners&&(Object.keys(n.mediaElement.listeners).forEach(t=>{n.mediaElement.removeEventListener(t,n.mediaElement.listeners[t])}),n.mediaElement.listeners=null,n.mediaElement.paused||this.dotnet.invokeMethodAsync("HandleOnPause"),this.dotnet.invokeMethodAsync("HandleOnInputDisconnected"))})}reconnectInputs(){const n=this.audioMotion.audioCtx,t=this.options?.queryOwner?.querySelectorAll?this.options.queryOwner:document,i=this.options.connectAll?Array.from(t.querySelectorAll("audio, video")):this.options.audioElements;this.disconnectInputs();this.connectToMic(this.options.connectMicrophone);i?.forEach(t=>{if(t&&(t.__internalId===undefined||t.__internalId)){if(!t.audioSourceNode){t.audioSourceNode=n.createMediaElementSource(t);const i=n.createGain();t.audioSourceNode.connect(i);i.connect(n.destination)}this.audioMotion.connectInput(t.audioSourceNode);t.listeners||(t.listeners={play:()=>this.dotnet.invokeMethodAsync("HandleOnPlay"),pause:()=>this.dotnet.invokeMethodAsync("HandleOnPause"),ended:()=>this.dotnet.invokeMethodAsync("HandleOnEnded")},Object.keys(t.listeners).forEach(n=>{t.addEventListener(n,t.listeners[n])}));t.paused||this.dotnet.invokeMethodAsync("HandleOnPlay");this.dotnet.invokeMethodAsync("HandleOnInputConnected")}})}removeAllMediaElementListeners(){const n=this.options?.queryOwner?.querySelectorAll?this.options.queryOwner:document,t=Array.from(n.querySelectorAll("audio, video"));t.forEach(n=>{n.listeners&&(Object.keys(n.listeners).forEach(t=>{n.removeEventListener(t,n.listeners[t])}),n.listeners=null)})}setOptions(n){this.audioMotion.setOptions(this.options=this.prepareOptions(n));this.reconnectInputs()}async togglePip(){if(document.pictureInPictureEnabled)if(document.pictureInPictureElement)return this._tmpVideoElement&&this._tmpVideoElement.remove(),await document.exitPictureInPicture(),!1;else{this._tmpVideoElement=document.createElement("video");this._tmpVideoElement.style.display="none";document.body.appendChild(this._tmpVideoElement);const n=this.audioMotion.canvas.captureStream();return this._tmpVideoElement.srcObject=n,await this._tmpVideoElement.play(),await this._tmpVideoElement.requestPictureInPicture(),!0}else return console.warn("Picture-in-Picture-Mode not supported by browser"),!1}_ensureNamespace(n){for(var i,u=n.split("."),t=window,r=0;r<u.length;r++)i=u[r],t[i]&&typeof t[i]!="undefined"||(t[i]={}),t=t[i]}toggleFullscreen(){return this.audioMotion.toggleFullscreen(),this.audioMotion.isFullscreen}dispose(){this.visualizer.removeEventListener("click",this.onVisualizerClick.bind(this));this.disconnectInputs();this.audioMotion.destroy()}}window.Auralizer=n;window.AuralizeBlazor={features:{}};window.AuralizeBlazor.features.energyMeter={onCanvasDraw:(n,t,i,r)=>{const e=r,f=e.canvas,u=e.canvasCtx,c=e.pixelRatio,h=Math.max(20*c,f.height/27|0),v=f.width>>1,l=f.height>>1,d=e.getEnergy(),y=e.getEnergy("peak"),o=50*c,p=-f.height*(y-1);i.showPeakEnergyBar===!0&&(u.fillRect(o,p,o,2),u.font=`${16*c}px sans-serif`,u.textAlign="left",u.fillText(y.toFixed(4),o,p-4),u.fillRect(o,f.height,o,-f.height*d));const s=(n,t,i)=>{const e=o>>1,s=o<<1,r=u.createLinearGradient(0,0,0,f.height);r.addColorStop(0,t);r.addColorStop(.75,`${t}0`);u.beginPath();u.moveTo(n-e,0);u.lineTo(n-s,f.height);u.lineTo(n+s,f.height);u.lineTo(n+e,0);u.save();u.fillStyle=r;u.shadowColor=t;u.shadowBlur=40;u.globalCompositeOperation="screen";u.globalAlpha=i;u.fill();u.restore()};u.textAlign="center";const a=h*4,w=e.getEnergy("bass");i.bassText&&(u.font=`bold ${h+a*w}px sans-serif`,u.fillText(i.bassText,f.width*.15,l));i.showBassLight&&s(f.width*.15,"#f00",w);i.showMidrangeLight&&s(f.width*.325,"#f80",e.getEnergy("lowMid"));const b=e.getEnergy("mid");i.midrangeText&&(u.font=`bold ${h+a*b}px sans-serif`,u.fillText(i.midrangeText,v,l));i.showMidrangeLight&&(s(v,"#ff0",b),s(f.width*.675,"#0f0",e.getEnergy("highMid")));const k=e.getEnergy("treble");i.trebleText&&(u.font=`bold ${h+a*k}px sans-serif`,u.fillText(i.trebleText,f.width*.85,l));i.showTrebleLight&&s(f.width*.85,"#0ff",k)}};window.AuralizeBlazor.features.radialRadius={onCanvasDraw:(n,t,i,r)=>{r.radius=t.options.radius+r.getEnergy()}};window.AuralizeBlazor.features.showLogo={_getCoordinates:function(n,t,i,r,u){const s=n=>{const t={"top-left":0,"0":0,"top-center":1,"1":1,"top-right":2,"2":2,"center-left":3,"3":3,"center-center":4,"4":4,"center-right":5,"5":5,"bottom-left":6,"6":6,"bottom-center":7,"7":7,"bottom-right":8,"8":8};return t[n.toString().toLowerCase()]||t["0"]};let h=s(n?.position),f,e,o;switch(h){case 0:f=t;e=t*2;o="left";break;case 1:f=i;e=t*2;break;case 2:f=u.width-t;e=t*2;o="right";break;case 3:f=t;e=r;o="left";break;case 4:f=i;e=r;break;case 5:f=u.width-t;e=r;o="right";break;case 6:f=t;e=u.height-t;o="left";break;case 7:f=i;e=u.height-t;break;case 8:f=u.width-t;e=u.height-t;o="right"}return{x:f,y:e,textAlign:o}},onCanvasDraw:(n,t,i)=>{const r=t.audioMotion,u=r.canvas,f=r.canvasCtx,o=r.pixelRatio,s=Math.max(20*o,u.height/27|0),h=u.width>>1,c=u.height>>1,e=n._getCoordinates(i,s,h,c,u);f.font=`${s+r.getEnergy()*25*o}px Orbitron, sans-serif`;f.textAlign=e.textAlign||"center";i?.labelColor||(f.fillStyle=i.labelColor);f.fillText(i?.label||"AuralizeBlazor",e.x,e.y)}};window.AuralizeBlazor.features.switchPresetFeature=(()=>{let n=0;const t=(t,i,r,u)=>{const f=Date.now();if(f-n>r.minDebounceTimeInMs){const t=u.getEnergy("bass");t>r.minEnergy&&(i.dotnet.invokeMethodAsync(r.pickRandom?"RandomPreset":"NextPresetAsync"),n=f)}};return{onCanvasDraw:t}})();window.AuralizeBlazor.features.waveNode={onCanvasDraw:(n,t,i,r,u)=>{if(r.audioCtx){n.waveformNode||(n.waveformNode=r.audioCtx.createAnalyser(),n.waveformNode.fftSize=4096,r.connectOutput(n.waveformNode));const f=r.canvasCtx,o=f.canvas,e=n.waveformNode.fftSize,c=new Uint8Array(e),s=Math.max(1,Math.floor(e/o.width)),l=o.width/e*s,a=o.height/4;n.waveformNode.getByteTimeDomainData(c);f.lineWidth=1;f.strokeStyle=u.canvasGradients[1];f.beginPath();let h=0;for(let n=0;n<e-s;n+=s){const t=c[n]/128*a;n==0?f.moveTo(h,t):f.lineTo(h,t);h+=l}f.stroke()}}};