export function initializeAuralizer(t,i,r,u){return new n(t,i,r,u)}class n{elementRef;dotnet;audioMotion;isSimulating=false;_featuresPaused=false;_createdAudioElements=[];connectedStreams=[];visualizerAction;constructor(n,t,i,r){this.elementRef=n;this.dotnet=t;this.options=i;this.visualizerAction=r;this.createVisualizer(i);window.AuralizeBlazor.instance=this}createVisualizer(n){this.audioMotion=new(window.AudioMotionAnalyzer||(window.AudioMotionAnalyzer=n.audioMotion.default))(this.visualizer=n.visualizer,this.options=this.prepareOptions(n));this.visualizer&&(this.visualizer.addEventListener("click",this.onVisualizerClick.bind(this)),this.visualizer.addEventListener("dblclick",this.onVisualizerDblClick.bind(this)),this.visualizer.addEventListener("contextmenu",this.onVisualizerCtxMenu.bind(this)),this.visualizer.addEventListener("mousemove",this.onVisualizerMouseMove.bind(this)));this.reconnectInputs();this.dotnet.invokeMethodAsync("HandleOnCreated");this.clickTimeout=null;this.preventSingleClick=!1;this.analyzer=this.audioMotion._analyzer[0];this.originalGetFloatFrequencyData=this.analyzer.getFloatFrequencyData.bind(this.analyzer);n.initialRender>0&&this.renderOneTimeStatic()}record({duration:n=5e3,fps:t=30}={}){const i=this.audioMotion.audioCtx,l=this.audioMotion.canvas;i.state==="suspended"&&i.resume();const a=l.captureStream(t),f=i.createMediaStreamDestination(),e=i.createGain();e.gain.value=1;e.connect(f);let o=!1;const u=(n,t)=>{try{n.connect(e);console.log(`Audioquelle verbunden: ${t}`);o=!0}catch(i){console.warn(`Fehler beim Verbinden von ${t}:`,i)}};if(this.connectedStreams&&this.connectedStreams.length>0&&this.connectedStreams.forEach((n,t)=>{u(n,`connectedStreams[${t}]`)}),this.audioMotion.connectedSources&&this.audioMotion.connectedSources.length>0&&this.audioMotion.connectedSources.forEach((n,t)=>{n.audioSourceNode&&u(n.audioSourceNode,`connectedSources[${t}]`)}),this.micStream&&(s,u(this.micStream,"micStream")),!o){const n=this.getAudioElements();n&&n.length>0&&n.forEach((n,t)=>{if(!n.paused)try{let r;n.__auralizerAudioSource?r=n.__auralizerAudioSource:(r=i.createMediaElementSource(n),n.__auralizerAudioSource=r);u(r,`getAudioElements[${t}]`)}catch(r){console.warn(`Fehler beim Verbinden von MediaElement ${t}:`,r)}})}setTimeout(()=>{console.log("Audio Destination Tracks:",f.stream.getAudioTracks())},100);const v=new MediaStream([...a.getVideoTracks(),...f.stream.getAudioTracks()]),h={mimeType:"video/webm; codecs=vp9",videoBitsPerSecond:8e6,audioBitsPerSecond:32e4},c=[];let r;try{r=new MediaRecorder(v,h)}catch(y){console.error("MediaRecorder konnte nicht erstellt werden:",y);return}r.ondataavailable=n=>{n.data&&n.data.size>0&&c.push(n.data)};r.onstop=()=>{const t=new Blob(c,{type:h.mimeType});console.log("Aufgezeichneter Blob:",t,"Größe:",t.size);t.size===0&&console.warn("Der Blob ist leer – es wurde kein Audio oder Video aufgezeichnet.");const i=URL.createObjectURL(t),n=document.createElement("a");n.href=i;n.download="recording.webm";document.body.appendChild(n);n.click();setTimeout(()=>{document.body.removeChild(n),URL.revokeObjectURL(i)},100)};r.start();setTimeout(()=>{r.stop(),console.log("Aufnahme gestoppt.")},n)}async renderOneTimeStatic(){const n=this.getAudioElements();if(this.options.initialRender===1||this.options.initialRender===6){const n=this.generateRandomAudioFrequencyData();this.setAudioData(n)}if((this.options.initialRender===2||this.options.initialRender===3||this.options.initialRender===6)&&n.length>0){const t=await Promise.all(n.map(async n=>await(this.options.initialRender===2?this.getRealAudioFrequencyData(n):this.getFullAudioSpectrumFrequencyData(n,!0)))),i=this.combineFrequencyData(t);this.setAudioData(i)}this.options.initialRender===4&&this.simulateRandomAudioSpectrum();this.options.initialRender===5&&this.simulateFullAudioSpectrum(n[0],1,!0)}disableOutput(){this.audioMotion.volume=0}_captureStream=null;_isSelecting=false;async connectToCapture(n=false){if(!this._isSelecting)try{if(!this._captureStream){this._isSelecting=!0;const t={audio:!0,displaySurface:"browser",selfBrowserSurface:"include",surfaceSwitching:"include",logicalSurface:!0,systemAudio:"include",preferCurrentTab:n};this._captureStream=await navigator.mediaDevices.getDisplayMedia(t)}const t=this.audioMotion.audioCtx.createMediaStreamSource(this._captureStream);t.stream=this._captureStream;const i=()=>{this._captureStream&&this._captureStream.removeEventListener("inactive",i);const n=this.connectedStreams.indexOf(t);n>=0&&this.connectedStreams.splice(n,1);this._captureStream=null;this.reconnectInputs()};this._captureStream.addEventListener("inactive",i);this.connectedStreams.push(t);this.audioMotion.connectInput(t);this.disableOutput();this.audioMotion.isOn||this.audioMotion.toggleAnalyzer(!0)}catch(t){console.error("getDisplayMedia failed or cancelled:",t)}finally{this._isSelecting=!1}}setAudioData(n,t=true){this.analyzer.getFloatFrequencyData=this._tmpGetFloatFrequencyData=function(t){t.set(n)};t&&this.audioMotion.toggleAnalyzer(!0);setTimeout(()=>{t&&(this.audioMotion.toggleAnalyzer(!1),this.analyzer.getFloatFrequencyData=this.originalGetFloatFrequencyData)},100)}combineFrequencyData(n){const t=n[0].length,i=new Float32Array(t);n.forEach(n=>{for(let r=0;r<t;r++)i[r]+=n[r]});for(let r=0;r<t;r++)i[r]/=n.length;return i}generateRandomAudioFrequencyData(){const t=.6;let i=Math.random()*20-80;const n=new Float32Array(this.audioMotion._analyzer[0].frequencyBinCount);for(let r=0;r<n.length;r++){const f=Math.random()*30-80,u=i*t+f*(1-t);n[r]=u;i=u}return n}async getRealAudioFrequencyData(n){const u=new(window.AudioContext||window.webkitAudioContext),o=typeof n=="string"?n:n.src,s=await fetch(o),h=await s.arrayBuffer(),f=await u.decodeAudioData(h),i=new OfflineAudioContext(1,f.length,u.sampleRate),r=i.createBufferSource();r.buffer=f;const t=i.createAnalyser();t.fftSize=this.options.fftSize;r.connect(t);t.connect(i.destination);r.start();await i.startRendering();const e=new Float32Array(t.frequencyBinCount);return t.getFloatFrequencyData(e),e}async getFullAudioSpectrumFrequencyData(n,t=false){const f=new(window.AudioContext||window.webkitAudioContext),c=typeof n=="string"?n:n.src,l=await fetch(c),a=await l.arrayBuffer(),u=await f.decodeAudioData(a),r=this.options.fftSize||2048,e=r/4,o=Math.ceil(u.length/e),s=[];let i;const h=[];t&&(i=new Float32Array(r/2));for(let n=0;n<o;n++){const a=n*e,w=a+r,b=a/u.sampleRate*1e3;h.push(b);const v=u.getChannelData(0).slice(a,w),o=new OfflineAudioContext(1,v.length,f.sampleRate),p=o.createBuffer(1,v.length,o.sampleRate);p.copyToChannel(v,0);const y=o.createBufferSource();y.buffer=p;const c=o.createAnalyser();c.fftSize=r;y.connect(c);c.connect(o.destination);y.start();await o.startRendering();const l=new Float32Array(c.frequencyBinCount);if(c.getFloatFrequencyData(l),t)for(let n=0;n<l.length;n++)i[n]+=l[n];else s.push(l)}if(t){for(let n=0;n<i.length;n++)i[n]/=o;return i}return{frequencyDataArray:s,timestamps:h}}isSimulationRunning(){return this.isSimulating}stopSimulation(){this.isSimulating&&(this.isSimulating=!1,this._simulationStopped=!0,this._simulateId&&clearInterval(this._simulateId),setTimeout(()=>this.audioMotion.toggleAnalyzer(!0),100))}simulateRandomAudioSpectrum(){this.isSimulating||(this.isSimulating=!0,this._simulateId=setInterval(()=>{this.simulationIsPaused()||requestAnimationFrame(()=>this.setAudioData(this.generateRandomAudioFrequencyData(),!1))},10))}simulateRandomAudioSpectrumContinueWithFullSpectrum(n,t=1,i=false){if(n||(n=this.getAudioElements()[0]),n){const r="frequencyDataArray"in n?Promise.resolve(n):this.getFullAudioSpectrumFrequencyData(n,!1);r.then(n=>{clearInterval(this._simulateId),this.simulateFullAudioSpectrum(n,t,i)})}this.simulateRandomAudioSpectrum()}async simulateFullAudioSpectrum(n,t=1,i=false){if(n||(n=this.getAudioElements()[0]),!n)return Promise.resolve();const{frequencyDataArray:s,timestamps:a}="frequencyDataArray"in n?n:await this.getFullAudioSpectrumFrequencyData(n,!1),h=this.analyzer,c=this.originalGetFloatFrequencyData;this.isSimulating=!0;const f=s.length;let r=0,e=0,u=0,l=performance.now();const o=()=>{if(this.simulationIsPaused()){u===0&&(u=performance.now());requestAnimationFrame(o);return}u!==0&&(e+=performance.now()-u,u=0);const n=performance.now()-l-e;while(r<f&&a[r]<=n*t)r++;requestAnimationFrame(o)};return new Promise(n=>{h.getFloatFrequencyData=this._tmpGetFloatFrequencyData=function(n){c(n);r<f?n.set(s[r]):n.fill(-Infinity)};this.audioMotion.toggleAnalyzer(!0);requestAnimationFrame(o);const t=()=>{if(r>=f||this._simulationStopped){if(i&&!this._simulationStopped){r=0;l=performance.now();e=0;u=0;setTimeout(t,100);return}this._simulationStopped=!1;h.getFloatFrequencyData=c;this._tmpGetFloatFrequencyData=null;this.isSimulating=!1;n()}else setTimeout(t,100)};t()})}simulationIsPaused(){return this._simulationPaused}pauseSimulation(n){this.isSimulating&&(this._simulationPaused=!0,this.analyzer.getFloatFrequencyData=this.originalGetFloatFrequencyData,n||this.audioMotion.toggleAnalyzer(!1))}resumeSimulation(){this.isSimulating&&(this._tmpGetFloatFrequencyData&&(this.analyzer.getFloatFrequencyData=this._tmpGetFloatFrequencyData),this._simulationPaused=!1,this.audioMotion.isOn||this.audioMotion.toggleAnalyzer(!0))}async onVisualizerMouseMove(){}async onVisualizerCtxMenu(n){await this.handleAction(this.options.visualizerCtxMenuAction,n)}async onVisualizerDblClick(n){this.preventSingleClick=!0;this.clickTimeout&&clearTimeout(this.clickTimeout);await this.handleAction(this.options.visualizerDblClickAction,n)}async onVisualizerClick(n){this.clickTimeout=setTimeout(async()=>{this.preventSingleClick||await this.dotnet.invokeMethodAsync("ClickInAlreadyHandled")||await this.handleAction(this.options.visualizerClickAction,n),this.preventSingleClick=!1},300)}async handleAction(n,t){if(n!==0){t.preventDefault&&t.preventDefault();switch(n){case this.visualizerAction.TogglePlayPause:this.pauseAllActive()||this.playAllActive(!0)||this.playAllActive();break;case this.visualizerAction.ToggleAllFeatures:this._featuresPaused=!this._featuresPaused;break;case this.visualizerAction.TogglePictureInPicture:this.togglePip();break;case this.visualizerAction.ToggleFullscreen:this.toggleFullscreen();break;case this.visualizerAction.ToggleMicrophone:this.connectToMic(!this.micStream);break;case this.visualizerAction.NextPreset:await this.dotnet.invokeMethodAsync("NextPresetAsync",3);break;case this.visualizerAction.PreviousPreset:await this.dotnet.invokeMethodAsync("PreviousPresetAsync",3);break;case this.visualizerAction.NextTrack:await this.dotnet.invokeMethodAsync("NextTrackAsync",this.currentTrack());break;case this.visualizerAction.PreviousTrack:await this.dotnet.invokeMethodAsync("PreviousTrackAsync",this.currentTrack());break;case this.visualizerAction.ToggleFullPage:await this.dotnet.invokeMethodAsync("ToggleFullPage");break;case this.visualizerAction.DisplayActionMenu:await this.dotnet.invokeMethodAsync("ToggleActionMenu");break;case this.visualizerAction.DisplayTrackList:await this.dotnet.invokeMethodAsync("ToggleTrackList");break;case this.visualizerAction.DisplayPresetList:await this.dotnet.invokeMethodAsync("TogglePresetList")}}}currentTrack(){const n=(this.audioMotion?.connectedSources??[])[0]?.mediaElement??(this.getAudioElements()??[])[0];return n?.src}invokeMethod(n,t,...i){const u=n.split(".");let r=window;for(const n of u.slice(0,-1))if(r=r[n],!r)return;if(r=r[u[u.length-1]],r){const f=r[t];f&&typeof f=="function"&&f.apply(r,[r].concat(i))}}prepareOptions(n){return n.fsElement=n.fsElement||n.visualizer,n.gradientLeft=n.gradientLeft||n.gradient,n.gradientRight=n.gradientRight||n.gradient,n.backgroundImageToApply&&(this.visualizer.style.backgroundImage=`url('${n.backgroundImageToApply}')`,this.visualizer.style.backgroundSize=n.backgroundSize||"cover",this.visualizer.style.backgroundRepeat=n.backgroundRepeat||"no-repeat",this.visualizer.style.backgroundPosition=n.backgroundPosition||"center"),n.features&&n.features.forEach(n=>this._ensureNamespace(n.jsNamespace)),n.gradient=this.registerGradientIfRequired(n.gradient),n.gradientLeft=this.registerGradientIfRequired(n.gradientLeft),n.gradientRight=this.registerGradientIfRequired(n.gradientRight),n.onCanvasDraw=(t,i)=>{!this._featuresPaused&&n.features&&n.features.forEach(n=>{const r=n.onCanvasDrawCallbackName,u=n.jsNamespace;this.invokeMethod(u,r,this,n.options||{},t,i)})},n.overlay=n.overlay||n.backgroundImageToApply,n}getCurrentColors(){return[...new Set(this.getColorsFromGradient(this.audioMotion.gradient).concat(this.getColorsFromGradient(this.audioMotion.gradientLeft)).concat(this.getColorsFromGradient(this.audioMotion.gradientRight)))]}getCurrentColorStops(){return[...new Set(this.getColorStopsFromGradient(this.audioMotion.gradient).concat(this.getColorStopsFromGradient(this.audioMotion.gradientLeft)).concat(this.getColorStopsFromGradient(this.audioMotion.gradientRight)))]}getColorsFromGradient(n){return this.getColorStopsFromGradient(n).map(n=>n.color)}getColorStopsFromGradient(n){if(!n)return[];var t=this.audioMotion._gradients[n]?.colorStops;return t?t:[]}updateGradient(n,t,i){this.audioMotion.setOptions({gradient:this.registerGradientIfRequired(n),gradientLeft:this.registerGradientIfRequired(t),gradientRight:this.registerGradientIfRequired(i)});this.audioMotion?.redraw&&this.audioMotion.redraw()}registerGradientIfRequired(n){if(!n)return"classic";if(typeof n=="string")return n;if(!this.audioMotion||!n.name)return"classic";const t=n.name.toLowerCase();return this.audioMotion?._gradients?.[t]||!n.colorStops||n.isPredefined?t:(this.audioMotion.registerGradient(t,n),t)}connectToMic(n){if(!n&&this.micStream)this.audioMotion.disconnectInput(this.micStream,!0),this.audioMotion.connectOutput(),this.micStream=null;else if(n&&!this.micStream){const n=this.options.microphoneDeviceId,t=n?{audio:{deviceId:{exact:n}}}:{audio:!0};navigator.mediaDevices.getUserMedia(t).then(n=>{this.micStream=this.audioMotion.audioCtx.createMediaStreamSource(n),this.audioMotion.disconnectOutput(),this.audioMotion.connectInput(this.micStream)}).catch(()=>console.log("Error accessing user microphone."))}}playAllActive(n){let i=!1,t=this.audioMotion?.connectedSources?.filter(n=>n.mediaElement).map(n=>n.mediaElement);return(!t||t.length<=0)&&(t=this.getAudioElements()),t?.forEach(t=>{if(t&&t.paused){if(n&&!t.__autoPaused)return;t.play();delete t.__autoPaused;i=!0}}),i}pauseAllActive(){let t=!1,n=this.audioMotion?.connectedSources?.filter(n=>n.mediaElement).map(n=>n.mediaElement);return(!n||n.length<=0)&&(n=this.getAudioElements()),n?.forEach(n=>{n&&!n.paused&&(n.__autoPaused=!0,n.pause(),t=!0)}),t}disconnectInputs(){if(this.connectedStreams.length>0){for(const n of this.connectedStreams)try{this.audioMotion.disconnectInput(n)}catch(t){console.error("Error disconnecting stream from audioMotion:",t)}this.connectedStreams=[]}this.audioMotion?.connectedSources?.forEach(n=>{this.audioMotion.disconnectInput(n.gain),n.mediaElement&&n.mediaElement.listeners&&(Object.keys(n.mediaElement.listeners).forEach(t=>{n.mediaElement.removeEventListener(t,n.mediaElement.listeners[t])}),n.mediaElement.listeners=null,n.mediaElement.paused||this.dotnet.invokeMethodAsync("HandleOnPause"))});this.connectToMic(!1)}_connectToStream(n){n.stream||(n.stream=n.captureStream());const r=n.stream.getAudioTracks();if(r.length<=0){const t=()=>{n?.stream?.removeEventListener("addtrack",t),this._connectToStream(n)};n.stream.addEventListener("addtrack",t);return}var t=this.audioMotion.audioCtx.createMediaStreamSource(n.stream);const i=()=>{n?.stream?.removeEventListener("inactive",i),n.stream=null,this.reconnectInputs()};n.stream.addEventListener("inactive",i);this.connectedStreams.push(t);this.audioMotion.connectInput(t);this.disableOutput()}_createGainNode(n){const t=this.audioMotion.audioCtx;n.audioSourceNode=t.createMediaElementSource(n);const i=t.createGain();return n.audioSourceNode.connect(i),i.connect(t.destination),n.audioSourceNode}_connectTo(n){if(this.options.connectionMode===1)this._connectToStream(n);else{n.audioSourceNode||this.options.connectionMode!==0||(n.audioSourceNode=this._createGainNode(n));try{this.audioMotion.connectInput(n.audioSourceNode??n)}catch(t){console.error("Error connecting audio source to audioMotion:",t)}}}getOwner(){return this.options?.queryOwner?.querySelectorAll?this.options.queryOwner:document}getAudioElements(){const n=(this.options.connectAll?Array.from(this.getOwner().querySelectorAll("audio, video")):this.options.audioElements)??[];return[...n,...(this._createdAudioElements??[])]}reconnectInputs(){const n=this.audioMotion.audioCtx,t=this.getAudioElements();this.disconnectInputs();this.options.connectToCapture&&this.options.connectToCapture!==0&&this.connectToCapture(this.options.connectToCapture===2);this.connectToMic(this.options.connectMicrophone);for(const i of t)i&&(i.__internalId===undefined||i.__internalId)&&(this._connectTo(i),i.listeners||(i.listeners={play:()=>{this.options.connectionMode!==1||i.stream||this._connectToStream(i),n.state==="suspended"&&n.resume(),(this.options.keepState||this.options.initialRender>0)&&(this.audioMotion.isOn||this.audioMotion.toggleAnalyzer(!0)),this.options.keepState?this.pauseSimulation(!0):this.stopSimulation(),this.dotnet.invokeMethodAsync("HandleOnPlay")},pause:()=>{this.options.keepState&&(this.audioMotion.toggleAnalyzer(!1),this.resumeSimulation()),this.dotnet.invokeMethodAsync("HandleOnPause")},ended:()=>this.dotnet.invokeMethodAsync("HandleOnEnded")},Object.keys(i.listeners).forEach(n=>{i.addEventListener(n,i.listeners[n])})),i.paused||this.dotnet.invokeMethodAsync("HandleOnPlay"),this.dotnet.invokeMethodAsync("HandleOnInputConnected"));this.dotnet.invokeMethodAsync("UpdateCurrentTrack",this.currentTrack())}removeAllMediaElementListeners(){const n=this.options?.queryOwner?.querySelectorAll?this.options.queryOwner:document,t=Array.from(n.querySelectorAll("audio, video"));t.forEach(n=>{n.listeners&&(Object.keys(n.listeners).forEach(t=>{n.removeEventListener(t,n.listeners[t])}),n.listeners=null)})}playTrack(n){const t=(this.audioMotion?.connectedSources??[])[0]?.mediaElement??(this.getAudioElements()??[])[0];if(t)t.stream=null,t.src=n,t.play();else{const t=document.createElement("audio");this._createdAudioElements.push(t);this.reconnectInputs();t.src=n;t.play()}}isPlaying(){return this.getAudioElements().some(n=>!n.paused||n.autoplay)}setOptions(n){this.audioMotion.setOptions(this.options=this.prepareOptions(n));this.reconnectInputs()}renderOneTimeStaticIf(n){(n||!this.isSimulationRunning()&&this.options.initialRender>0&&!this.isPlaying())&&this.renderOneTimeStatic()}async togglePip(){if(document.pictureInPictureEnabled)if(document.pictureInPictureElement)return this._tmpVideoElement&&this._tmpVideoElement.remove(),await document.exitPictureInPicture(),!1;else{this._tmpVideoElement=document.createElement("video");this._tmpVideoElement.style.display="none";document.body.appendChild(this._tmpVideoElement);const n=this.audioMotion.canvas.captureStream();return this._tmpVideoElement.srcObject=n,await this._tmpVideoElement.play(),await this._tmpVideoElement.requestPictureInPicture(),!0}else return console.warn("Picture-in-Picture-Mode not supported by browser"),!1}_ensureNamespace(n){for(var i,u=n.split("."),t=window,r=0;r<u.length;r++)i=u[r],t[i]&&typeof t[i]!="undefined"||(t[i]={}),t=t[i]}toggleFullscreen(){return this.audioMotion.toggleFullscreen(),this.audioMotion.isFullscreen}async readBlobAsByteArray(n){console.log("READ THE BLOB BYTES");const i=await fetch(n),r=await i.blob(),t=await r.arrayBuffer();return console.log("ARRAY BUFFER",t),Array.from(new Uint8Array(t))}dispose(){this.visualizer.removeEventListener("click",this.onVisualizerClick.bind(this));this.visualizer.removeEventListener("dblclick",this.onVisualizerDblClick.bind(this));this.visualizer.removeEventListener("contextmenu",this.onVisualizerCtxMenu.bind(this));this.visualizer.removeEventListener("mousemove",this.onVisualizerMouseMove.bind(this));this.disconnectInputs();this.audioMotion.destroy()}}window.Auralizer=n;window.AuralizeBlazor={features:{}};window.AuralizeBlazor.features.energyMeter={onCanvasDraw:(n,t,i,r)=>{const e=r,f=e.canvas,u=e.canvasCtx,c=e.pixelRatio,h=Math.max(20*c,f.height/27|0),v=f.width>>1,l=f.height>>1,d=e.getEnergy(),y=e.getEnergy("peak"),o=50*c,p=-f.height*(y-1);i.showPeakEnergyBar===!0&&(u.fillRect(o,p,o,2),u.font=`${16*c}px sans-serif`,u.textAlign="left",u.fillText(y.toFixed(4),o,p-4),u.fillRect(o,f.height,o,-f.height*d));const s=(n,t,i)=>{const e=o>>1,s=o<<1,r=u.createLinearGradient(0,0,0,f.height);r.addColorStop(0,t);r.addColorStop(.75,`${t}0`);u.beginPath();u.moveTo(n-e,0);u.lineTo(n-s,f.height);u.lineTo(n+s,f.height);u.lineTo(n+e,0);u.save();u.fillStyle=r;u.shadowColor=t;u.shadowBlur=40;u.globalCompositeOperation="screen";u.globalAlpha=i;u.fill();u.restore()};u.textAlign="center";const a=h*4,w=e.getEnergy("bass");i.bassText&&(u.font=`bold ${h+a*w}px sans-serif`,u.fillText(i.bassText,f.width*.15,l));i.showBassLight&&s(f.width*.15,"#f00",w);i.showMidrangeLight&&s(f.width*.325,"#f80",e.getEnergy("lowMid"));const b=e.getEnergy("mid");i.midrangeText&&(u.font=`bold ${h+a*b}px sans-serif`,u.fillText(i.midrangeText,v,l));i.showMidrangeLight&&(s(v,"#ff0",b),s(f.width*.675,"#0f0",e.getEnergy("highMid")));const k=e.getEnergy("treble");i.trebleText&&(u.font=`bold ${h+a*k}px sans-serif`,u.fillText(i.trebleText,f.width*.85,l));i.showTrebleLight&&s(f.width*.85,"#0ff",k)}};window.AuralizeBlazor.features.lyricsDisplay={onCanvasDraw:function(n,t,i,r){function at(n){return n*(2-n)}function vt(n){if(n===0)return 1;if(n===1)return.7;if(n===-1){var t=(c-.5)*2;return t=Math.min(1,Math.max(0,t)),.7*(1-t)}return.5}function ut(n,t,i){var r=u.createLinearGradient(n-t/2,0,n+t/2,0);try{i&&g>.5?(r.addColorStop(0,o[0]),r.addColorStop(.5,"#ffffff"),r.addColorStop(1,o[o.length-1])):o.forEach(function(n,t){r.addColorStop(t/(o.length-1),n)})}catch(f){}return r}var e,h,p,s,f,v,l,w,b,g,c,nt,rt;if(t.options.lyrics&&t.options.lyrics.lines){e=i.textPosition||"middle";typeof e=="number"&&(e===0?e="top":e===1?e="middle":e===2&&(e="bottom"));e!=="top"&&e!=="middle"&&e!=="bottom"&&(e="middle");var ft=i.baseFontSize||40,et=i.lineSpacing||50,o=i.gradientColors||t.getCurrentColors();(!o||o.length<=0)&&(o=["#ff0088","#ff8800","#ffff00"]);o.length===1&&o.push(o[0]);var ot=i.enableWordAnimation,st=i.wordAnimationMaxX||50,ht=i.wordAnimationMaxY||30,tt=r.canvas,u=r.canvasCtx,k=tt.width,a=tt.height,y=Math.min(k/800,a/600),it=ft*y,d=et*y,ct=st*y,lt=ht*y;for(u.fillStyle="rgba(0, 0, 0, 0.1)",u.fillRect(0,0,k,a),h=0,t.getTime&&typeof t.getTime=="function"?h=t.getTime():(p=AuralizeBlazor.instance.getAudioElements(),p&&p.length>0&&(h=p[0].currentTime)),t.options?.lyrics?.lines&&!t.options.lyrics._parsed&&(t.options.lyrics.lines.forEach(function(n){if(n&&!n.timeSeconds){var t=n.timeStamp.split(":");n.timeSeconds=t.length===3?parseInt(t[0],10)*3600+parseInt(t[1],10)*60+parseFloat(t[2]):0}}),t.options.lyrics.lines.sort(function(n,t){return n?.timeSeconds-t?.timeSeconds}),t.options.lyrics._parsed=!0),s=t.options.lyrics.lines,f=-1,v=0;v<s.length;v++)if(s[v]?.timeSeconds<=h)f=v;else break;f===-1&&(f=0);l=[];s[0]?.timeSeconds>h?l=[0]:(f>0&&l.push(f-1),l.push(f),f<s.length-1&&l.push(f+1));w=null;s[0]?.timeSeconds>h?w=0:f<s.length-1&&(w=f+1);b=e==="top"?a*.2:e==="bottom"?a*.8:a/2;g=r.getEnergy?r.getEnergy():0;c=0;f<s.length-1&&(nt=s[f],rt=s[f+1],c=(h-nt?.timeSeconds)/(rt?.timeSeconds-nt?.timeSeconds),c=Math.min(1,Math.max(0,c)));l.forEach(function(n){var t=s[n],r=n-f,e=r*d,v,o,y,l,p,tt,ht,yt;if(r===0&&(e-=c*d),r===-1&&(e-=c*d),v=vt(r),o=it,r===0&&(o=it*1.2),o*=1+g*.1,y=r===0?"bold":"normal",u.font=y+" "+o+"px sans-serif",u.textAlign="center",u.textBaseline="middle",l=k/2,i.showTimer&&n===w&&t&&t.timeSeconds&&t.timeSeconds>h){p=Math.ceil(t.timeSeconds-h);const n=i?.countDownFormatStr||"{0}";var pt=n.replace("{0}",p),nt=o*.6,wt=u.font;u.font=y+" "+nt+"px sans-serif";u.fillStyle="#ffffff";u.globalAlpha=v;tt=b+e-nt-5;u.fillText(pt,l,tt);u.font=wt}if(ot&&t?.text){var a=t.text.split(" "),rt=[],ft=0;a.forEach(function(n,t){var r=n+(t<a.length-1?" ":""),i=u.measureText(r).width;rt.push(i);ft+=i});var bt=l-ft/2,et=bt,st=at(c);a.forEach(function(n,t){var p=n+(t<a.length-1?" ":""),i=rt[t],h=et+i/2,f,o,s;et+=i;f=0;o=0;r===-1&&(s=(t/a.length-.5)*Math.PI,f=Math.cos(s)*ct*st,o=-Math.sin(s)*lt*st);var c=h+f,l=b+e+o,y=ut(h,i,r===0);u.fillStyle=y;u.globalAlpha=v;u.fillText(n,c,l)})}else t?.text&&(ht=u.measureText(t.text).width,yt=ut(l,ht,r===0),u.fillStyle=yt,u.globalAlpha=v,u.fillText(t.text,l,b+e))});u.globalAlpha=1}}};window.AuralizeBlazor.features.lineParticle={onCanvasDraw:(n,t,i,r)=>{const c=r.canvas,u=r.canvasCtx,e=c.width,o=c.height,l=e/2,a=o/2;u.fillStyle="rgba(0, 0, 0, 0.1)";u.fillRect(0,0,e,o);const f=r.getEnergy?r.getEnergy():0,w=r.getEnergy?r.getEnergy("bass"):0,b=r.getEnergy?r.getEnergy("mid"):0,k=r.getEnergy?r.getEnergy("treble"):0,v=performance.now()/1e3;if(!n.lineParticles||n.lineParticles.length!==i.particleCount){n.lineParticles=[];const t=i.particleCount;for(let i=0;i<t;i++)n.lineParticles.push({x:Math.random()*e,y:Math.random()*o,vx:(Math.random()-.5)*1.5,vy:(Math.random()-.5)*1.5,baseSize:2+Math.random()*3,sizeOsc:Math.random()*Math.PI*2,color:`hsl(${Math.random()*360}, 80%, 60%)`})}for(let t of n.lineParticles){t.x+=t.vx*(1+f*2);t.y+=t.vy*(1+f*2);t.x<0&&(t.x+=e);t.x>e&&(t.x-=e);t.y<0&&(t.y+=o);t.y>o&&(t.y-=o);const r=(Math.sin(v*2+t.sizeOsc)+1)/2,i=t.baseSize*(.5+r),n=u.createRadialGradient(t.x,t.y,0,t.x,t.y,i);n.addColorStop(0,t.color);n.addColorStop(1,"rgba(0, 0, 0, 0)");u.beginPath();u.arc(t.x,t.y,i,0,Math.PI*2);u.fillStyle=n;u.fill()}const y=i.connectionThreshold||50;for(let t=0;t<n.lineParticles.length;t++)for(let i=t+1;i<n.lineParticles.length;i++){const r=n.lineParticles[t],e=n.lineParticles[i],o=r.x-e.x,s=r.y-e.y,h=Math.sqrt(o*o+s*s);if(h<y){const n=(1-h/y)*(.3+f*.7),t=1+f*2;u.strokeStyle=`rgba(255, 255, 255, ${n})`;u.lineWidth=t;u.beginPath();u.moveTo(r.x,r.y);u.lineTo(e.x,e.y);u.stroke()}}u.save();u.translate(l,a);u.rotate(v*.2);const p=Math.min(e,o)/3,s=u.createRadialGradient(0,0,0,0,0,p);s.addColorStop(0,`rgba(255, 255, 255, ${.2+f*.5})`);s.addColorStop(1,"rgba(0, 0, 0, 0)");u.fillStyle=s;u.beginPath();const h=120;u.moveTo(0,0);for(let n=0;n<h;n++){const t=n/h*Math.PI*8,i=n/h*p*(1+f*.5),r=i*Math.cos(t),e=i*Math.sin(t);u.lineTo(r,e)}u.lineTo(0,0);u.closePath();u.fill();u.restore();i.epicText&&(u.font=`bold ${Math.floor(40+f*50)}px sans-serif`,u.textAlign="center",u.textBaseline="middle",u.fillStyle=`rgba(255, 255, 255, ${.7+f*.3})`,u.fillText(i.epicText,l,a))}};window.AuralizeBlazor.features.vortexParticle={onCanvasDraw:(n,t,i,r)=>{const v=r.canvas,u=r.canvasCtx,e=v.width,o=v.height,w=e/2,b=o/2,s=performance.now()/1e3,h=w+Math.sin(s*.3)*(e/4),c=b+Math.cos(s*.3)*(o/4);u.fillStyle="rgba(0, 0, 0, 0.1)";u.fillRect(0,0,e,o);const f=r.getEnergy?r.getEnergy():0,k=r.getEnergy?r.getEnergy("bass"):0,d=r.getEnergy?r.getEnergy("mid"):0,g=r.getEnergy?r.getEnergy("treble"):0;if(!n.vortexParticles||n.vortexParticles.length!==i.particleCount){n.vortexParticles=[];const r=i.particleCount,t=200;for(let i=0;i<r;i++){const i=Math.random()*Math.PI*2,r=Math.random()*Math.min(e,o)/2,u=Math.random()*t-t/2,f=(Math.random()-.5)*.5;n.vortexParticles.push({angle:i,radius:r,speed:.005+Math.random()*.01,size:1+Math.random()*2,color:`hsl(${Math.random()*360}, 80%, 60%)`,z:u,zSpeed:f})}}const y=300;n.vortexParticles.forEach(n=>{n.angle+=n.speed*(1+f*5);n.radius+=Math.sin(s*2+n.angle)*.5*f;n.z+=n.zSpeed*(1+f);const t=200;n.z>t/2&&(n.z=t/2,n.zSpeed=-Math.abs(n.zSpeed));n.z<-t/2&&(n.z=-t/2,n.zSpeed=Math.abs(n.zSpeed));const i=y/(y+n.z),r=h+n.radius*Math.cos(n.angle)*i,e=c+n.radius*Math.sin(n.angle)*i,l=(n.size+f*4)*i;u.beginPath();u.arc(r,e,l,0,Math.PI*2);const o=u.createRadialGradient(r,e,0,r,e,l);o.addColorStop(0,n.color);o.addColorStop(1,"rgba(0, 0, 0, 0)");u.fillStyle=o;u.fill()});u.save();u.translate(h,c);u.rotate(s*.2);const p=Math.min(e,o)/3,l=u.createRadialGradient(0,0,0,0,0,p);l.addColorStop(0,`rgba(255, 255, 255, ${.2+f*.5})`);l.addColorStop(1,"rgba(0, 0, 0, 0)");u.fillStyle=l;u.beginPath();const a=120;u.moveTo(0,0);for(let n=0;n<a;n++){const t=n/a*Math.PI*8,i=n/a*p*(1+f*.5),r=i*Math.cos(t),e=i*Math.sin(t);u.lineTo(r,e)}u.lineTo(0,0);u.closePath();u.fill();u.restore();i.epicText&&(u.font=`bold ${Math.floor(40+f*50)}px sans-serif`,u.textAlign="center",u.textBaseline="middle",u.fillStyle=`rgba(255, 255, 255, ${.7+f*.3})`,u.fillText(i.epicText,h,c))}};window.AuralizeBlazor.features.radialRadius={onCanvasDraw:(n,t,i,r)=>{r.radius=t.options.radius+r.getEnergy()}};window.AuralizeBlazor.features.showLogo={_getCoordinates:function(n,t,i,r,u,f,e,o){const l={"top-left":0,"0":0,"top-center":1,"1":1,"top-right":2,"2":2,"center-left":3,"3":3,"center-center":4,"4":4,"center-right":5,"5":5,"bottom-left":6,"6":6,"bottom-center":7,"7":7,"bottom-right":8,"8":8,random:9,"9":9},v=n=>l[n.toString().toLowerCase()]??l["0"];let a=v(n.position),s,h,c="center";if(a===l.random){e.__randomCoords||(e.__randomCoords={});const l=n.randomMinEnergy,r=n.randomChangeDebounceInMs.min,a=n.randomChangeDebounceInMs.max,i=Date.now();if(e.__randomCoords[o])if(f>l&&i-e.__randomCoords[o].lastUpdate>=e.__randomCoords[o].waitTime){const n=200+Math.random()*800;s=t+Math.random()*(u.width-2*t);h=t+Math.random()*(u.height-2*t);c="center";e.__randomCoords[o]={x:s,y:h,textAlign:c,lastUpdate:i,waitTime:n}}else s=e.__randomCoords[o].x,h=e.__randomCoords[o].y,c=e.__randomCoords[o].textAlign;else{const n=r+Math.random()*(a-r);s=t+Math.random()*(u.width-2*t);h=t+Math.random()*(u.height-2*t);c="center";e.__randomCoords[o]={x:s,y:h,textAlign:c,lastUpdate:i,waitTime:n}}return{x:s,y:h,textAlign:c}}switch(a){case l["top-left"]:s=t;h=t*2;c="left";break;case l["top-center"]:s=i;h=t*2;c="center";break;case l["top-right"]:s=u.width-t;h=t*2;c="right";break;case l["center-left"]:s=t;h=r;c="left";break;case l["center-center"]:s=i;h=r;c="center";break;case l["center-right"]:s=u.width-t;h=r;c="right";break;case l["bottom-left"]:s=t;h=u.height-t;c="left";break;case l["bottom-center"]:s=i;h=u.height-t;c="center";break;case l["bottom-right"]:s=u.width-t;h=u.height-t;c="right"}return s+=n.margin.left,s-=n.margin.right,h+=n.margin.top,h-=n.margin.bottom,{x:s,y:h,textAlign:c}},onCanvasDraw:(n,t,i,r)=>{const e=t.audioMotion,u=e.canvas,f=e.canvasCtx,s=e.pixelRatio,c=Math.max(20*s,u.height/27|0)*(i?.textScale??1),l=u.width>>1,a=u.height>>1,o=e.getEnergy(),h=n._getCoordinates(i?.labelPosition,c,l,a,u,o,r,"label");if(f.font=`${c+o*25*s}px Orbitron, sans-serif`,f.textAlign=h.textAlign||"center",i?.labelColor&&(f.fillStyle=i.labelColor),f.fillText(i?.label||"",h.x,h.y),i?.image){let t=i.image;if(typeof t=="string"){if(r.__cachedImages||(r.__cachedImages={}),!r.__cachedImages[t]){const n=new Image;n.src=t;r.__cachedImages[t]=n}t=r.__cachedImages[t]}if(!t.complete)return;const v=t.naturalWidth*(i?.imageScale??1),e=n._getCoordinates(i?.imagePosition,v,l,a,u,o,r,"image"),h=v+o*35*s;let c=e.x;e.textAlign==="right"?c=e.x-h:e.textAlign==="center"&&(c=e.x-h/2);const y=e.y-h/2;f.drawImage(t,c,y,h,h)}}};window.AuralizeBlazor.features.switchPresetFeature=(()=>{let n=0,t=0;const i=(i,r,u,f)=>{let o=u.minEnergyForColor??u.minEnergy,s=u.minDebounceForColorTimeInMs??u.minDebounceTimeInMs,e=Date.now();if(u.overridePresetColorsWithRandoms&&e-t>s){let n=f.getEnergy("bass");n>o&&(r.dotnet.invokeMethodAsync("RandomColor"),t=e)}if(e-n>u.minDebounceTimeInMs){let t=f.getEnergy("bass");t>u.minEnergy&&(r.dotnet.invokeMethodAsync(u.pickRandom?"RandomPreset":"NextPresetAsync",5),n=e)}};return{onCanvasDraw:i}})();window.AuralizeBlazor.features.waveNode={onCanvasDraw:(n,t,i,r,u)=>{if(r.audioCtx){n.waveformNode||(n.waveformNode=r.audioCtx.createAnalyser(),n.waveformNode.fftSize=4096,r.connectOutput(n.waveformNode));const f=r.canvasCtx,o=f.canvas,e=n.waveformNode.fftSize,c=new Uint8Array(e),s=Math.max(1,Math.floor(e/o.width)),l=o.width/e*s,a=o.height/4;n.waveformNode.getByteTimeDomainData(c);f.lineWidth=1;f.strokeStyle=u.canvasGradients[1];f.beginPath();let h=0;for(let n=0;n<e-s;n+=s){const t=c[n]/128*a;n==0?f.moveTo(h,t):f.lineTo(h,t);h+=l}f.stroke()}}};